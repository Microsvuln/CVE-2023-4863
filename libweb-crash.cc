//// Microsvuln
//// CVE-2023-4863 - Trigerring the libweb bug with libfuzzer

#include <stdint.h>
#include <stdlib.h>
#include <string.h>

#include "src/dec/vp8li_dec.h"
#include "src/utils/bit_reader_utils.h"
#include "src/utils/huffman_utils.h"
#include "src/utils/utils.h"
#include "src/webp/format_constants.h"

extern "C" int LLVMFuzzerTestOneInput(const uint8_t *data, size_t size) {
  if (size < 2) {
    return 0;
  }

  const int root_bits = (data[0] % 8) + 1;
  const size_t code_lengths_size = size - 1;

  int* code_lengths = new int[code_lengths_size];
  for (size_t i = 0; i < code_lengths_size; ++i) {
    code_lengths[i] = data[i + 1];
  }

  const int table_size = 1 << root_bits;
  HuffmanCode* root_table = new HuffmanCode[table_size];
  memset(root_table, 0, table_size * sizeof(HuffmanCode));

  int result = VP8LBuildHuffmanTable(root_table, root_bits, code_lengths, code_lengths_size);

  delete[] root_table;
  delete[] code_lengths;
  (void)result;
  return 0;
}

